   1               		.file	"matrix.c"
   2               	__SP_H__ = 0x3e
   3               	__SP_L__ = 0x3d
   4               	__SREG__ = 0x3f
   5               	__tmp_reg__ = 0
   6               	__zero_reg__ = 1
   7               		.text
   8               	.Ltext0:
   9               		.cfi_sections	.debug_frame
  10               		.section	.text.matrix_init,"ax",@progbits
  11               	.global	matrix_init
  13               	matrix_init:
  14               	.LFB7:
  15               		.file 1 "matrix.c"
   1:matrix.c      **** /*
   2:matrix.c      **** Copyright 2012 Jun Wako <wakojun@gmail.com>
   3:matrix.c      **** 
   4:matrix.c      **** This program is free software: you can redistribute it and/or modify
   5:matrix.c      **** it under the terms of the GNU General Public License as published by
   6:matrix.c      **** the Free Software Foundation, either version 2 of the License, or
   7:matrix.c      **** (at your option) any later version.
   8:matrix.c      **** 
   9:matrix.c      **** This program is distributed in the hope that it will be useful,
  10:matrix.c      **** but WITHOUT ANY WARRANTY; without even the implied warranty of
  11:matrix.c      **** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  12:matrix.c      **** GNU General Public License for more details.
  13:matrix.c      **** 
  14:matrix.c      **** You should have received a copy of the GNU General Public License
  15:matrix.c      **** along with this program.  If not, see <http://www.gnu.org/licenses/>.
  16:matrix.c      **** */
  17:matrix.c      **** 
  18:matrix.c      **** #include <stdint.h>
  19:matrix.c      **** #include <stdbool.h>
  20:matrix.c      **** #include <avr/io.h>
  21:matrix.c      **** #include <util/delay.h>
  22:matrix.c      **** #include "print.h"
  23:matrix.c      **** #include "util.h"
  24:matrix.c      **** #include "news.h"
  25:matrix.c      **** #include "matrix.h"
  26:matrix.c      **** #include "debug.h"
  27:matrix.c      **** 
  28:matrix.c      **** 
  29:matrix.c      **** /*
  30:matrix.c      ****  * Matrix Array usage:
  31:matrix.c      ****  *
  32:matrix.c      ****  * ROW: 16
  33:matrix.c      ****  * COL:8
  34:matrix.c      ****  *
  35:matrix.c      ****  *    8bit wide
  36:matrix.c      ****  *   +---------+
  37:matrix.c      ****  *  0|00 ... 07|
  38:matrix.c      ****  *  1|08 ... 0F|
  39:matrix.c      ****  *  :|   ...   |
  40:matrix.c      ****  *  :|   ...   |
  41:matrix.c      ****  *  E|70 ... 77|
  42:matrix.c      ****  *  F|78 ... 7F|
  43:matrix.c      ****  *   +---------+
  44:matrix.c      ****  *
  45:matrix.c      ****  */
  46:matrix.c      **** static uint8_t matrix[MATRIX_ROWS];
  47:matrix.c      **** #define ROW(code)      ((code>>3)&0xF)
  48:matrix.c      **** #define COL(code)      (code&0x07)
  49:matrix.c      **** 
  50:matrix.c      **** 
  51:matrix.c      **** void matrix_init(void)
  52:matrix.c      **** {
  16               		.loc 1 52 1 view -0
  17               		.cfi_startproc
  18               	/* prologue: function */
  19               	/* frame size = 0 */
  20               	/* stack size = 0 */
  21               	.L__stack_usage = 0
  53:matrix.c      ****     news_init();
  22               		.loc 1 53 5 view .LVU1
  23 0000 0E94 0000 		call news_init
  24               	.LVL0:
  54:matrix.c      **** 
  55:matrix.c      ****     // initialize matrix state: all keys off
  56:matrix.c      ****     for (uint8_t i=0; i < MATRIX_ROWS; i++) matrix[i] = 0x00;
  25               		.loc 1 56 5 view .LVU2
  26               	.LBB2:
  27               		.loc 1 56 10 view .LVU3
  28               		.loc 1 56 10 is_stmt 0 view .LVU4
  29 0004 E0E0      		ldi r30,lo8(matrix)
  30 0006 F0E0      		ldi r31,hi8(matrix)
  31               	.LVL1:
  32               	.L2:
  33               		.loc 1 56 45 is_stmt 1 discriminator 3 view .LVU5
  34               		.loc 1 56 55 is_stmt 0 discriminator 3 view .LVU6
  35 0008 1192      		st Z+,__zero_reg__
  36               	.LVL2:
  37               		.loc 1 56 5 discriminator 3 view .LVU7
  38 000a 80E0      		ldi r24,hi8(matrix+16)
  39 000c E030      		cpi r30,lo8(matrix+16)
  40 000e F807      		cpc r31,r24
  41 0010 01F4      		brne .L2
  42               	/* epilogue start */
  43               	.LBE2:
  57:matrix.c      **** 
  58:matrix.c      ****     return;
  59:matrix.c      **** }
  44               		.loc 1 59 1 view .LVU8
  45 0012 0895      		ret
  46               		.cfi_endproc
  47               	.LFE7:
  49               		.section	.text.matrix_scan,"ax",@progbits
  50               	.global	matrix_scan
  52               	matrix_scan:
  53               	.LFB8:
  60:matrix.c      **** 
  61:matrix.c      **** uint8_t matrix_scan(void)
  62:matrix.c      **** {
  54               		.loc 1 62 1 is_stmt 1 view -0
  55               		.cfi_startproc
  56 0000 1F93      		push r17
  57               	.LCFI0:
  58               		.cfi_def_cfa_offset 3
  59               		.cfi_offset 17, -2
  60 0002 CF93      		push r28
  61               	.LCFI1:
  62               		.cfi_def_cfa_offset 4
  63               		.cfi_offset 28, -3
  64 0004 DF93      		push r29
  65               	.LCFI2:
  66               		.cfi_def_cfa_offset 5
  67               		.cfi_offset 29, -4
  68               	/* prologue: function */
  69               	/* frame size = 0 */
  70               	/* stack size = 3 */
  71               	.L__stack_usage = 3
  63:matrix.c      ****     uint8_t code;
  72               		.loc 1 63 5 view .LVU10
  64:matrix.c      ****     code = news_recv();
  73               		.loc 1 64 5 view .LVU11
  74               		.loc 1 64 12 is_stmt 0 view .LVU12
  75 0006 0E94 0000 		call news_recv
  76               	.LVL3:
  77 000a D82F      		mov r29,r24
  78               	.LVL4:
  65:matrix.c      ****     if (code == 0) {
  79               		.loc 1 65 5 is_stmt 1 view .LVU13
  80               		.loc 1 65 8 is_stmt 0 view .LVU14
  81 000c 8823      		tst r24
  82 000e 01F0      		breq .L4
  66:matrix.c      ****         return 0;
  67:matrix.c      ****     }
  68:matrix.c      **** 
  69:matrix.c      ****     phex(code); print(" ");
  83               		.loc 1 69 5 is_stmt 1 view .LVU15
  84               	.LBB3:
  85               		.loc 1 69 5 view .LVU16
  86               		.loc 1 69 5 view .LVU17
  87               	.LBE3:
  88 0010 1F92      		push __zero_reg__
  89               	.LCFI3:
  90               		.cfi_def_cfa_offset 6
  91 0012 8F93      		push r24
  92               	.LCFI4:
  93               		.cfi_def_cfa_offset 7
  94 0014 80E0      		ldi r24,lo8(__c.1927)
  95 0016 90E0      		ldi r25,hi8(__c.1927)
  96               	.LVL5:
  97               		.loc 1 69 5 is_stmt 0 view .LVU18
  98 0018 9F93      		push r25
  99               	.LCFI5:
 100               		.cfi_def_cfa_offset 8
 101 001a 8F93      		push r24
 102               	.LCFI6:
 103               		.cfi_def_cfa_offset 9
 104 001c 0E94 0000 		call __xprintf
 105               	.LVL6:
 106               		.loc 1 69 17 is_stmt 1 view .LVU19
 107               	.LBB4:
 108               		.loc 1 69 17 view .LVU20
 109               		.loc 1 69 17 view .LVU21
 110               	.LBE4:
 111 0020 80E0      		ldi r24,lo8(__c.1929)
 112 0022 90E0      		ldi r25,hi8(__c.1929)
 113 0024 0E94 0000 		call xputs
 114               	.LVL7:
  70:matrix.c      ****     if (code&0x80) {
 115               		.loc 1 70 5 view .LVU22
 116 0028 1D2F      		mov r17,r29
 117 002a 1770      		andi r17,lo8(7)
 118 002c CD2F      		mov r28,r29
 119 002e C695      		lsr r28
 120 0030 C695      		lsr r28
 121 0032 C695      		lsr r28
 122               		.loc 1 70 8 is_stmt 0 view .LVU23
 123 0034 0F90      		pop __tmp_reg__
 124 0036 0F90      		pop __tmp_reg__
 125 0038 0F90      		pop __tmp_reg__
 126 003a 0F90      		pop __tmp_reg__
 127               	.LCFI7:
 128               		.cfi_def_cfa_offset 5
 129 003c D7FF      		sbrs r29,7
 130 003e 00C0      		rjmp .L6
  71:matrix.c      ****         // break code
  72:matrix.c      ****         if (matrix_is_on(ROW(code), COL(code))) {
 131               		.loc 1 72 9 is_stmt 1 view .LVU24
 132               		.loc 1 72 13 is_stmt 0 view .LVU25
 133 0040 CF70      		andi r28,lo8(15)
 134 0042 612F      		mov r22,r17
 135 0044 8C2F      		mov r24,r28
 136 0046 0E94 0000 		call matrix_is_on
 137               	.LVL8:
 138               		.loc 1 72 12 view .LVU26
 139 004a 8823      		tst r24
 140 004c 01F0      		breq .L4
  73:matrix.c      ****             matrix[ROW(code)] &= ~(1<<COL(code));
 141               		.loc 1 73 13 is_stmt 1 view .LVU27
 142               		.loc 1 73 31 is_stmt 0 view .LVU28
 143 004e EC2F      		mov r30,r28
 144 0050 F0E0      		ldi r31,0
 145 0052 E050      		subi r30,lo8(-(matrix))
 146 0054 F040      		sbci r31,hi8(-(matrix))
 147               		.loc 1 73 37 view .LVU29
 148 0056 81E0      		ldi r24,lo8(1)
 149 0058 90E0      		ldi r25,0
 150 005a 00C0      		rjmp 2f
 151               		1:
 152 005c 880F      		lsl r24
 153               		2:
 154 005e 1A95      		dec r17
 155 0060 02F4      		brpl 1b
 156               		.loc 1 73 31 view .LVU30
 157 0062 8095      		com r24
 158 0064 9081      		ld r25,Z
 159 0066 8923      		and r24,r25
 160               	.L13:
  74:matrix.c      ****         }
  75:matrix.c      ****     } else {
  76:matrix.c      ****         // make code
  77:matrix.c      ****         if (!matrix_is_on(ROW(code), COL(code))) {
  78:matrix.c      ****             matrix[ROW(code)] |=  (1<<COL(code));
 161               		.loc 1 78 31 view .LVU31
 162 0068 8083      		st Z,r24
 163               	.L4:
  79:matrix.c      ****         }
  80:matrix.c      ****     }
  81:matrix.c      ****     return code;
  82:matrix.c      **** }
 164               		.loc 1 82 1 view .LVU32
 165 006a 8D2F      		mov r24,r29
 166               	/* epilogue start */
 167 006c DF91      		pop r29
 168               	.LVL9:
 169               		.loc 1 82 1 view .LVU33
 170 006e CF91      		pop r28
 171 0070 1F91      		pop r17
 172 0072 0895      		ret
 173               	.LVL10:
 174               	.L6:
  77:matrix.c      ****             matrix[ROW(code)] |=  (1<<COL(code));
 175               		.loc 1 77 9 is_stmt 1 view .LVU34
  77:matrix.c      ****             matrix[ROW(code)] |=  (1<<COL(code));
 176               		.loc 1 77 14 is_stmt 0 view .LVU35
 177 0074 612F      		mov r22,r17
 178 0076 8C2F      		mov r24,r28
 179 0078 0E94 0000 		call matrix_is_on
 180               	.LVL11:
  77:matrix.c      ****             matrix[ROW(code)] |=  (1<<COL(code));
 181               		.loc 1 77 12 view .LVU36
 182 007c 8111      		cpse r24,__zero_reg__
 183 007e 00C0      		rjmp .L4
  78:matrix.c      ****         }
 184               		.loc 1 78 13 is_stmt 1 view .LVU37
  78:matrix.c      ****         }
 185               		.loc 1 78 31 is_stmt 0 view .LVU38
 186 0080 EC2F      		mov r30,r28
 187 0082 F0E0      		ldi r31,0
 188 0084 E050      		subi r30,lo8(-(matrix))
 189 0086 F040      		sbci r31,hi8(-(matrix))
  78:matrix.c      ****         }
 190               		.loc 1 78 37 view .LVU39
 191 0088 21E0      		ldi r18,lo8(1)
 192 008a 30E0      		ldi r19,0
 193 008c 00C0      		rjmp 2f
 194               		1:
 195 008e 220F      		lsl r18
 196               		2:
 197 0090 1A95      		dec r17
 198 0092 02F4      		brpl 1b
  78:matrix.c      ****         }
 199               		.loc 1 78 31 view .LVU40
 200 0094 8081      		ld r24,Z
 201 0096 822B      		or r24,r18
 202 0098 00C0      		rjmp .L13
 203               		.cfi_endproc
 204               	.LFE8:
 206               		.section	.text.matrix_get_row,"ax",@progbits
 207               	.global	matrix_get_row
 209               	matrix_get_row:
 210               	.LVL12:
 211               	.LFB9:
  83:matrix.c      **** 
  84:matrix.c      **** inline
  85:matrix.c      **** uint8_t matrix_get_row(uint8_t row)
  86:matrix.c      **** {
 212               		.loc 1 86 1 is_stmt 1 view -0
 213               		.cfi_startproc
 214               	/* prologue: function */
 215               	/* frame size = 0 */
 216               	/* stack size = 0 */
 217               	.L__stack_usage = 0
  87:matrix.c      ****     return matrix[row];
 218               		.loc 1 87 5 view .LVU42
 219               		.loc 1 87 18 is_stmt 0 view .LVU43
 220 0000 E82F      		mov r30,r24
 221 0002 F0E0      		ldi r31,0
 222 0004 E050      		subi r30,lo8(-(matrix))
 223 0006 F040      		sbci r31,hi8(-(matrix))
  88:matrix.c      **** }
 224               		.loc 1 88 1 view .LVU44
 225 0008 8081      		ld r24,Z
 226               	.LVL13:
 227               	/* epilogue start */
 228               		.loc 1 88 1 view .LVU45
 229 000a 0895      		ret
 230               		.cfi_endproc
 231               	.LFE9:
 233               		.section	.progmem.data.__c.1929,"a"
 236               	__c.1929:
 237 0000 2000      		.string	" "
 238               		.section	.progmem.data.__c.1927,"a"
 241               	__c.1927:
 242 0000 2530 3258 		.string	"%02X"
 242      00
 243               		.section	.bss.matrix,"aw",@nobits
 246               	matrix:
 247 0000 0000 0000 		.zero	16
 247      0000 0000 
 247      0000 0000 
 247      0000 0000 
 248               		.text
 249               	.Letext0:
 250               		.file 2 "../../tmk_core/common/debug.h"
 251               		.file 3 "/usr/avr/include/stdint.h"
 252               		.file 4 "../../tmk_core/common/avr/xprintf.h"
 253               		.file 5 "../../tmk_core/protocol/news.h"
 254               		.file 6 "../../tmk_core/common/matrix.h"
DEFINED SYMBOLS
                            *ABS*:0000000000000000 matrix.c
     /tmp/ccCd29m2.s:2      *ABS*:000000000000003e __SP_H__
     /tmp/ccCd29m2.s:3      *ABS*:000000000000003d __SP_L__
     /tmp/ccCd29m2.s:4      *ABS*:000000000000003f __SREG__
     /tmp/ccCd29m2.s:5      *ABS*:0000000000000000 __tmp_reg__
     /tmp/ccCd29m2.s:6      *ABS*:0000000000000001 __zero_reg__
     /tmp/ccCd29m2.s:13     .text.matrix_init:0000000000000000 matrix_init
     /tmp/ccCd29m2.s:246    .bss.matrix:0000000000000000 matrix
     /tmp/ccCd29m2.s:52     .text.matrix_scan:0000000000000000 matrix_scan
     /tmp/ccCd29m2.s:241    .progmem.data.__c.1927:0000000000000000 __c.1927
     /tmp/ccCd29m2.s:236    .progmem.data.__c.1929:0000000000000000 __c.1929
     /tmp/ccCd29m2.s:209    .text.matrix_get_row:0000000000000000 matrix_get_row

UNDEFINED SYMBOLS
news_init
news_recv
__xprintf
xputs
matrix_is_on
__do_clear_bss
